from pathlib import Path

from flatpak_node_generator.integrity import Integrity
from flatpak_node_generator.package import (
    Lockfile,
    Package,
    ResolvedSource,
)
from flatpak_node_generator.providers.yarn import YarnLockfileProvider

TEST_LOCKFILE = """
# This file is generated by running "yarn install" inside your project.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: 8
  cacheKey: 10c0

"bling@npm:^0.12.3":
  version: 0.12.3
  resolution: "bling@npm:0.12.3"
  checksum: 10c0/44a1686ba11075c72721980a3e4b881656497fef93873f900a702f9de297ce8b1caf858711cb3da89cb3121b0b13fd2174b890785a85240e68f9dd0f329f2136
  languageName: node
  linkType: hard

"isexe@https://github.com/isaacs/isexe":
  version: 3.1.1
  resolution: "isexe@https://github.com/isaacs/isexe.git#commit=e3078d94e64cb587201a290bdef17916d1342cf8"
  checksum: 10c0/cdf2ea84ddec39437ec5595e61d797dd8bb4e39f847f5b1abede325c650533b5053b2b90613a3b7687c46ab120e2565ccb84573f816fa7bf20017479aeb83a9d
  languageName: node
  linkType: hard

"test@workspace:.":
  version: 0.0.0-use.local
  resolution: "test@workspace:."
  dependencies:
    bling: "npm:^0.12.3"
    isexe: "https://github.com/isaacs/isexe"
    thing: "npm:^1.0.1"
  languageName: unknown
  linkType: soft

"thing@npm:^1.0.1":
  version: 1.0.1
  resolution: "thing@npm:1.0.1"
  checksum: 10c0/52e193e281a1f45b503e0863278cfece75ce0b188d2d8740def7af7fb87aeed14ee36ff777ba7969a510a23287b7b6c719c6c2bfc1313cb65dfa0a9799a0f3dc
  languageName: node
  linkType: hard
"""


def test_lockfile_parsing(tmp_path: Path) -> None:
    lockfile_provider = YarnLockfileProvider()

    yarn_lock = Lockfile(tmp_path / 'yarn.lock', 8, '10c0')
    yarn_lock.path.write_text(TEST_LOCKFILE)

    packages = list(lockfile_provider.process_lockfile(yarn_lock.path))

    assert packages == [
        Package(
            lockfile=yarn_lock,
            name='bling',
            version='0.12.3',
            source=ResolvedSource(
                resolved='resolution#bling@npm:0.12.3',
                integrity=Integrity(
                    'sha512',
                    '44a1686ba11075c72721980a3e4b881656497fef93873f900a702f9de297ce8b1caf858711cb3da89cb3121b0b13fd2174b890785a85240e68f9dd0f329f2136',
                ),
            ),
        ),
        Package(
            lockfile=yarn_lock,
            name='isexe',
            version='3.1.1',
            source=ResolvedSource(
                resolved='resolution#isexe@https://github.com/isaacs/isexe.git#commit=e3078d94e64cb587201a290bdef17916d1342cf8',
                integrity=Integrity(
                    'sha512',
                    'cdf2ea84ddec39437ec5595e61d797dd8bb4e39f847f5b1abede325c650533b5053b2b90613a3b7687c46ab120e2565ccb84573f816fa7bf20017479aeb83a9d',
                ),
            ),
        ),
        Package(
            lockfile=yarn_lock,
            name='thing',
            version='1.0.1',
            source=ResolvedSource(
                resolved='resolution#thing@npm:1.0.1',
                integrity=Integrity(
                    'sha512',
                    '52e193e281a1f45b503e0863278cfece75ce0b188d2d8740def7af7fb87aeed14ee36ff777ba7969a510a23287b7b6c719c6c2bfc1313cb65dfa0a9799a0f3dc',
                ),
            ),
        ),
    ]
