# flatpak-cpan-generator

Generates a sources file for a list of CPAN modules.

## Requirements

- App::cpanminus
- Getopt::Long::Descriptive
- JSON::MaybeXS
- LWP::UserAgent
- MetaCPAN::Client
- Capture::Tiny

Example installation on Fedora:

```bash
$ sudo dnf install 'perl(App::cpanminus)' 'perl(Getopt::Long::Descriptive)' ...
```

## Usage

You can run flatpak-cpan-generator like this:

```bash
$ flatpak-cpan-generator LWP::UserAgent Some::Other::Package ...
```

This will write a generated-sources.json (the filename can be changed via `-o/--output`) that:

- Downloads the dependencies into a directory named `perl-libs`. (You can change the directory
  name via `-d/--dir`.)
- Saves a file `install.sh` into the same directory as above that installs all the dependencies
  by running `perl Makefile.PL && make install` or `perl Build.PL && ./Build && ./Build install`
  inside each directory.

Note both Perl itself and modules installed via Makefile.PL tend to not have write
permission on shared objects they installed, which can break flatpak-builder. The example
below shows how to work around that via chmod.

## Example

```yaml
  # Installs Perl.
  # (Based on: https://github.com/flathub/io.github.Hexchat.Plugin.Perl)
  - name: perl
    no-autogen: true
    config-opts:
      - '-des'
      # Build a shared library.
      - '-Duseshrplib'
    build-options:
      cflags: '-fPIC'
      ldflags: '-fpic'
    sources:
      - type: archive
        url: https://www.cpan.org/src/5.0/perl-5.30.0.tar.gz
        sha256: 851213c754d98ccff042caa40ba7a796b2cee88c5325f121be5cbb61bbf975f2
      - type: shell
        commands:
          # Have Flatpak run the GNU-compatible configure script.
          - 'ln -s configure{.gnu,}'
    # Restore write permission to the Perl libraries.
    post-install:
      - 'chmod -R u+w /app/lib/perl5'
    # Clean up a bunch of stuff we don't need. Depending on your application,
    # you may have to drop some of these (e.g. *.pod).
    cleanup:
      - '/bin/corelist'
      - '/bin/cpan'
      - '/bin/enc2xs'
      - '/bin/encguess'
      - '/bin/h2ph'
      - '/bin/h2xs'
      - '/bin/instmodsh'
      - '/bin/json_pp'
      - '/bin/libnetcfg'
      - '/bin/perlbug'
      - '/bin/perldoc'
      - '/bin/perlivp'
      - '/bin/perlthanks'
      - '/bin/piconv'
      - '/bin/pl2pm'
      - '/bin/pod*'
      - '/bin/prove'
      - '/bin/ptar*'
      - '/bin/shasum'
      - '/bin/splain'
      - '/bin/xsubpp'
      - '/bin/zipdetails'
      - '/include'
      - '/man'
      - '*.pod'

  # Installs the modules generated by flatpak-cpan-generator.
  # Note that *any* Makefile.PL-style modules MUST be installed in this one step,
  # as once perllocal.pod is written in one module, it cannot be modified by others.
  - name: perl-libs
    buildsystem: simple
    build-commands:
      - 'perl-libs/install.sh'
    # Same as with the Perl module, we need to restore write permission.
    # However, -f is now passed to avoid errors from trying to touch files from the
    # above module that are now marked as read-only.
    post-install:
      - 'chmod -Rf u+w /app/lib/perl5/site_perl'
    sources:
      - generated-sources.json
    # This step should be customized based on the CPAN packages you're using.
    cleanup:
      - '/bin'
      - '/man'
```

## Background

flatpak-cpan-generator works by:

- Using cpanminus to install all the needed libraries into a separate directory. cpanminus is
  used over vanilla CPAN because the latter does not seem to support this use case at all.
- Parsing the output of cpanm in order to extract the names and versions of the installed packages.
- Querying CPAN to grab the distribution URLs for each and saving them into the sources file.

We can't just resolve the dependency list without cpanminus, because many CPAN packages don't
properly declare all their dependencies in the metadata. Therefore, the only way to find them
is to run or parse Makefile.PL, the latter of which cpanminus already does.
